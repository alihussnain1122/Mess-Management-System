@page
@model MessManagement.Pages.Account.ChangePasswordModel
@{
    ViewData["Title"] = "Change Password";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Mess Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Full Background -->
    <div class="fixed inset-0 z-0">
        <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80" 
             class="w-full h-full object-cover" alt="Background">
        <div class="absolute inset-0 bg-black/50"></div>
    </div>

    <!-- Content -->
    <div class="relative z-10 min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="mb-6">
                @if (User.IsInRole("Admin"))
                {
                    <a href="/Admin/Dashboard" class="text-emerald-400 hover:text-emerald-300 flex items-center transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Dashboard
                    </a>
                }
                else
                {
                    <a href="/User/Dashboard" class="text-emerald-400 hover:text-emerald-300 flex items-center transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Dashboard
                    </a>
                }
            </div>

            <div class="bg-white/15 backdrop-blur-xl rounded-2xl border border-white/20 p-8">
                <!-- Step 1: Request Verification Code -->
                @if (Model.Step == 1)
                {
                    <div class="text-center mb-6">
                        <div class="bg-blue-500/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                            <i class="fas fa-envelope text-blue-400 text-2xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white">Verify Your Identity</h1>
                        <p class="text-white/60 mt-1">We'll send a verification code to your email</p>
                        @if (!string.IsNullOrEmpty(Model.UserEmail))
                        {
                            <p class="text-emerald-400 text-sm mt-2">@Model.UserEmail</p>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="bg-red-500/20 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl mb-4">
                            <i class="fas fa-exclamation-circle mr-2"></i>@Model.ErrorMessage
                        </div>
                    }

                    @if (string.IsNullOrEmpty(Model.UserEmail))
                    {
                        <p class="text-white/70 text-sm mb-4 text-center">
                            No email is linked to your account. Please contact the administrator to add your email.
                        </p>
                    }
                    else
                    {
                        <form method="post" asp-page-handler="SendCode">
                            <p class="text-white/70 text-sm mb-4 text-center">
                                Click the button below to receive a 6-digit verification code at your registered email address.
                            </p>
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white py-3 rounded-xl font-semibold transition-all shadow-lg">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Send Verification Code
                            </button>
                        </form>
                    }
                }
                @if (Model.Step == 2)
                {
                    <div class="text-center mb-6">
                        <div class="bg-yellow-500/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-yellow-500/30">
                            <i class="fas fa-shield-alt text-yellow-400 text-2xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white">Enter Verification Code</h1>
                        <p class="text-white/60 mt-1">Check your email for the 6-digit code</p>
                        <p class="text-emerald-400 text-sm mt-2">@Model.UserEmail</p>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="bg-red-500/20 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl mb-4">
                            <i class="fas fa-exclamation-circle mr-2"></i>@Model.ErrorMessage
                        </div>
                    }

                    <form method="post" asp-page-handler="VerifyCode">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-white/70 mb-3 text-center">Verification Code</label>
                            <input type="text" asp-for="VerificationCode" maxlength="6"
                                   class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-4 text-white text-center text-2xl font-bold tracking-[0.5em] placeholder-white/40 focus:outline-none focus:border-emerald-500/50 focus:bg-white/15 transition-all" 
                                   placeholder="000000" />
                            <span asp-validation-for="VerificationCode" class="text-red-400 text-xs mt-1 block text-center"></span>
                        </div>

                        <button type="submit" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white py-3 rounded-xl font-semibold transition-all shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i>
                            Verify Code
                        </button>
                    </form>

                    <div class="mt-4 text-center">
                        <form method="post" asp-page-handler="SendCode" class="inline">
                            <button type="submit" class="text-emerald-400 hover:text-emerald-300 text-sm transition-colors">
                                <i class="fas fa-redo mr-1"></i>
                                Resend Code
                            </button>
                        </form>
                    </div>
                }
                @if (Model.Step == 3)
                {
                    <div class="text-center mb-6">
                        <div class="bg-emerald-500/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/30">
                            <i class="fas fa-key text-emerald-400 text-2xl"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white">Set New Password</h1>
                        <p class="text-white/60 mt-1">Your identity has been verified</p>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="bg-red-500/20 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl mb-4">
                            <i class="fas fa-exclamation-circle mr-2"></i>@Model.ErrorMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                    {
                        <div class="bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 px-4 py-3 rounded-xl mb-4">
                            <i class="fas fa-check-circle mr-2"></i>@Model.SuccessMessage
                        </div>
                        <div class="text-center">
                            @if (User.IsInRole("Admin"))
                            {
                                <a href="/Admin/Dashboard" class="inline-flex items-center bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white px-6 py-3 rounded-xl font-semibold transition-all shadow-lg">
                                    <i class="fas fa-home mr-2"></i>
                                    Go to Dashboard
                                </a>
                            }
                            else
                            {
                                <a href="/User/Dashboard" class="inline-flex items-center bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white px-6 py-3 rounded-xl font-semibold transition-all shadow-lg">
                                    <i class="fas fa-home mr-2"></i>
                                    Go to Dashboard
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <form method="post" asp-page-handler="ChangePassword">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-emerald-400 mb-1">New Password</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-3 text-white/50"><i class="fas fa-lock"></i></span>
                                        <input type="password" asp-for="NewPassword" id="newPassword"
                                               class="w-full bg-white/10 border border-white/20 rounded-xl pl-10 pr-12 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                               placeholder="Enter new password" />
                                        <button type="button" onclick="togglePassword('newPassword', 'eyeIcon1')" class="absolute right-3 top-3 text-white/40 hover:text-white/60">
                                            <i id="eyeIcon1" class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="NewPassword" class="text-red-400 text-sm"></span>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-emerald-400 mb-1">Confirm New Password</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-3 text-white/50"><i class="fas fa-check-double"></i></span>
                                        <input type="password" asp-for="ConfirmPassword" id="confirmPassword"
                                               class="w-full bg-white/10 border border-white/20 rounded-xl pl-10 pr-12 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                               placeholder="Confirm new password" />
                                        <button type="button" onclick="togglePassword('confirmPassword', 'eyeIcon2')" class="absolute right-3 top-3 text-white/40 hover:text-white/60">
                                            <i id="eyeIcon2" class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="ConfirmPassword" class="text-red-400 text-sm"></span>
                                </div>

                                <!-- Password Requirements -->
                                <div class="p-3 bg-white/5 rounded-xl">
                                    <p class="text-white/50 text-xs mb-2">Password must contain:</p>
                                    <ul class="text-white/40 text-xs space-y-1">
                                        <li><i class="fas fa-check text-emerald-400 mr-2"></i>At least 6 characters</li>
                                        <li><i class="fas fa-check text-emerald-400 mr-2"></i>One uppercase letter</li>
                                        <li><i class="fas fa-check text-emerald-400 mr-2"></i>One lowercase letter</li>
                                        <li><i class="fas fa-check text-emerald-400 mr-2"></i>One number</li>
                                    </ul>
                                </div>

                                <button type="submit" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white py-3 rounded-xl font-semibold transition-all shadow-lg mt-2">
                                    <i class="fas fa-save mr-2"></i>
                                    Update Password
                                </button>
                            </div>
                        </form>
                    }
                }
            </div>
        </div>
    </div>

    <script>
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    </script>
</body>
</html>
